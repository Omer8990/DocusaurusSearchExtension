================================================================================
CONTEXT BUNDLE FOR CLAUDE
Use this file to migrate the Scalable Typesense Search feature to the main project.
================================================================================

FILE: INTEGRATION_GUIDE.md
--------------------------------------------------------------------------------
# Integration Guide: Scalable Typesense Search

This guide details how to port the **Scalable Multi-Project Search** feature from the prototype into the main "Monolith" Docusaurus project.

## 1. Dependencies

First, install the necessary dependencies in the main project. 
**Note:** If the main project uses React 18/19, you may need `--legacy-peer-deps`.

```bash
npm install docusaurus-theme-search-typesense typesense-docsearch-react --legacy-peer-deps
```

## 2. Configuration (`docusaurus.config.ts`)

Update the `themeConfig.typesense` section.
**Crucial:** We use specific `query_by` weights and typo tolerance settings to ensure strict, relevant results.

```typescript
themeConfig: {
  typesense: {
    typesenseCollectionName: 'docusaurus-2', // Or your collection name
    typesenseServerConfig: {
      nodes: [
        {
          host: 'localhost', // Or your production host
          port: 8108,
          protocol: 'http',
        },
      ],
      apiKey: 'xyz',
    },
    // STRICT SEARCH PARAMETERS
    typesenseSearchParameters: {
      query_by: 'hierarchy.lvl1,hierarchy.lvl2,hierarchy.lvl3,hierarchy.lvl4,hierarchy.lvl5,hierarchy.lvl6,content',
      query_by_weights: '4,2,2,1,1,1,1',
      min_len_1typo: 4,
      min_len_2typo: 8,
    },
  },
}
```

## 3. The "Search Scope" Component

Copy the implementation of `SearchBar/index.tsx` and `SearchBar/styles.css` provided below.

**Key Implementation Details:**
1.  **Portal Hack:** We use `createPortal` to render the `<FilterBar>` inside the `.DocSearch-Modal` DOM node.
2.  **Mock Hooks:** We mocked `useSearchPage` and `useTypesenseContextualFilters` locally to avoid build errors.
3.  **Autocomplete:** The `FilterBar` component handles the multi-select logic.

--------------------------------------------------------------------------------

FILE: website/src/theme/SearchBar/index.tsx
--------------------------------------------------------------------------------
import React, {useState, useRef, useCallback, useMemo, useEffect} from 'react';
import {createPortal} from 'react-dom';
// @ts-ignore
import useDocusaurusContext from '@docusaurus/useDocusaurusContext';
// @ts-ignore
import {useHistory} from '@docusaurus/router';
// @ts-ignore
import {useBaseUrlUtils} from '@docusaurus/useBaseUrl';
// @ts-ignore
import Link from '@docusaurus/Link';
// @ts-ignore
import {isRegexpStringMatch} from '@docusaurus/theme-common';

// Local mock for useSearchPage
function useSearchPage() {
  return {
    generateSearchPageLink: (query: string) => `/search?q=${encodeURIComponent(query)}`,
  };
}

// Local mock for useTypesenseContextualFilters
function useTypesenseContextualFilters() {
  return "";
}

import {
  DocSearchButton,
  useDocSearchKeyboardEvents,
} from 'typesense-docsearch-react';
// @ts-ignore
import Translate, {translate} from '@docusaurus/Translate';
// @ts-ignore
import translations from '@theme/SearchTranslations';

import type {
  DocSearchModal as DocSearchModalType,
  DocSearchModalProps,
} from 'typesense-docsearch-react';
import type {
  InternalDocSearchHit,
  StoredDocSearchHit,
} from 'typesense-docsearch-react/dist/esm/types';
import type {AutocompleteState} from '@algolia/autocomplete-core';

// --- Configuration ---
const AVAILABLE_PROJECTS = [
  { label: 'Project A', value: 'docs-project_a-current' },
  { label: 'Project B', value: 'docs-project_b-current' },
  { label: 'Project C', value: 'docs-project_c-current' },
  { label: 'Community', value: 'docs-community-current' },
  { label: 'Tutorial', value: 'docs-default-current' },
];

type DocSearchProps = Omit<
  DocSearchModalProps,
  'onClose' | 'initialScrollY'
> & {
  contextualSearch?: string;
  externalUrlRegex?: string;
  searchPagePath: boolean | string;
};

// --- In-Modal Filter Bar (Chip + Autocomplete) ---

function FilterBar({ 
  selected, 
  onChange 
}: { 
  selected: string[]; 
  onChange: (s: string[]) => void 
}) {
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState("");
  const dropdownRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Filter projects based on query
  const filteredProjects = AVAILABLE_PROJECTS.filter(p => 
    p.label.toLowerCase().includes(query.toLowerCase())
  );

  // Focus input when opening
  useEffect(() => {
    if (isOpen) {
      setTimeout(() => inputRef.current?.focus(), 50);
    }
  }, [isOpen]);

  // Click outside to close
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const addProject = (value: string) => {
    if (!selected.includes(value)) {
      onChange([...selected, value]);
    }
    setIsOpen(false);
    setQuery("");
  };

  const removeProject = (value: string) => {
    onChange(selected.filter(s => s !== value));
  };

  const clearAll = () => {
    onChange([]);
  };

  return (
    <div className="ProjectFilter-Bar" ref={dropdownRef}>
       {/* Selected Chips */}
       {selected.map(val => {
         const proj = AVAILABLE_PROJECTS.find(p => p.value === val);
         return (
           <div key={val} className="ProjectFilter-Chip" onClick={() => removeProject(val)}>
             {proj?.label || val}
             <span className="ProjectFilter-Chip-Remove">×</span>
           </div>
         );
       })}

       {/* Add Button */}
       <button 
         className="ProjectFilter-AddButton"
         onClick={() => setIsOpen(!isOpen)}
       >
         <span>+ Add Scope</span>
       </button>

       {/* Autocomplete Dropdown */}
       {isOpen && (
         <div className="ProjectFilter-Dropdown">
           <input
             ref={inputRef}
             type="text"
             className="ProjectFilter-SearchInput"
             placeholder="Search projects..."
             value={query}
             onChange={(e) => setQuery(e.target.value)}
             onClick={(e) => e.stopPropagation()} // Prevent closing
           />
           <div className="ProjectFilter-List">
             {/* "Global" Option */}
             {query === "" && selected.length > 0 && (
                <div className="ProjectFilter-Item" onClick={clearAll} style={{ color: 'var(--ifm-color-primary)', fontWeight: 'bold' }}>
                  Clear Filters (Search All)
                </div>
             )}

             {filteredProjects.map(proj => {
               const isSelected = selected.includes(proj.value);
               return (
                 <div 
                   key={proj.value} 
                   className={`ProjectFilter-Item ${isSelected ? 'selected' : ''}`}
                   onClick={() => !isSelected && addProject(proj.value)}
                 >
                   {proj.label}
                   {isSelected && <span>✓</span>}
                 </div>
               );
             })}
             
             {filteredProjects.length === 0 && (
               <div style={{ padding: '10px', color: '#999', fontSize: '0.85rem' }}>
                 No projects found.
               </div>
             )}
           </div>
         </div>
       )}
    </div>
  );
}

// --- Main DocSearch Component ---

let DocSearchModal: typeof DocSearchModalType | null = null;

function DocSearch({
  contextualSearch,
  externalUrlRegex,
  ...props
}: DocSearchProps) {
  const {siteMetadata} = useDocusaurusContext();
  const [selectedProjects, setSelectedProjects] = useState<string[]>([]); 

  // --- Logic to Inject Filter Bar into Modal ---
  const [modalNode, setModalNode] = useState<Element | null>(null);

  const checkForModal = useCallback(() => {
    const modal = document.querySelector('.DocSearch-Modal');
    if (modal && modal !== modalNode) {
      setModalNode(modal);
    }
  }, [modalNode]);

  // --- Search Parameters Logic ---
  const contextualSearchFacetFilters =
    useTypesenseContextualFilters() as string;

  const configFacetFilters: string =
    props.typesenseSearchParameters?.filter_by ?? '';

  const facetFilters = contextualSearch
    ? [contextualSearchFacetFilters, configFacetFilters].filter((e) => e).join(' && ')
    : configFacetFilters;

  let activeFilter = facetFilters;
  if (selectedProjects.length > 0) {
    const joinedValues = selectedProjects.join(',');
    activeFilter = `docusaurus_tag:=[${joinedValues}]`;
  }

  const typesenseSearchParameters = {
    filter_by: activeFilter,
    ...props.typesenseSearchParameters,
  };

  const typesenseServerConfig = props.typesenseServerConfig;
  const typesenseCollectionName = props.typesenseCollectionName;

  const {withBaseUrl} = useBaseUrlUtils();
  const history = useHistory();
  const searchContainer = useRef<HTMLDivElement | null>(null);
  const searchButtonRef = useRef<HTMLButtonElement>(null);
  const [isOpen, setIsOpen] = useState(false);
  const [initialQuery, setInitialQuery] = useState<string | undefined>(
    undefined,
  );

  const importDocSearchModalIfNeeded = useCallback(() => {
    if (DocSearchModal) {
      return Promise.resolve();
    }

    return Promise.all([
      // @ts-ignore
      import('typesense-docsearch-react/modal') as Promise<
        typeof import('typesense-docsearch-react')
      >,
      // @ts-ignore
      import('typesense-docsearch-react/style'),
      // @ts-ignore
      import('./styles.css'),
    ]).then(([{DocSearchModal: Modal}]) => {
      DocSearchModal = Modal;
    });
  }, []);

  const onOpen = useCallback(() => {
    importDocSearchModalIfNeeded().then(() => {
      searchContainer.current = document.createElement('div');
      document.body.insertBefore(
        searchContainer.current,
        document.body.firstChild,
      );
      setIsOpen(true);
      
      const interval = setInterval(checkForModal, 100);
      setTimeout(() => clearInterval(interval), 2000); 
    });
  }, [importDocSearchModalIfNeeded, setIsOpen, checkForModal]);

  const onClose = useCallback(() => {
    setIsOpen(false);
    setModalNode(null); 
    searchContainer.current?.remove();
  }, [setIsOpen]);

  const onInput = useCallback(
    (event: KeyboardEvent) => {
      importDocSearchModalIfNeeded().then(() => {
        setIsOpen(true);
        setInitialQuery(event.key);
      });
    },
    [importDocSearchModalIfNeeded, setIsOpen, setInitialQuery],
  );

  const navigator = useRef({
    navigate({itemUrl}: {itemUrl?: string}) {
      if (isRegexpStringMatch(externalUrlRegex, itemUrl)) {
        window.location.href = itemUrl!;
      } else {
        history.push(itemUrl!);
      }
    },
  }).current;

  const transformItems = useRef<DocSearchModalProps['transformItems']>(
    (items) =>
      items.map((item) => {
        if (isRegexpStringMatch(externalUrlRegex, item.url)) {
          return item;
        }
        const url = new URL(item.url);
        return {
          ...item,
          url: withBaseUrl(`${url.pathname}${url.hash}`),
        };
      }),
  ).current;

  const Hit = ({hit, children}: any) => <Link to={hit.url}>{children}</Link>;
  const ResultsFooter = ({state, onClose}: any) => {
      const {generateSearchPageLink} = useSearchPage();
      return (
        <Link to={generateSearchPageLink(state.query)} onClick={onClose}>
          <Translate id="theme.SearchBar.seeAll" values={{count: state.context.nbHits}}>
            {'See all {count} results'}
          </Translate>
        </Link>
      );
  };

  const resultsFooterComponent = useMemo(
      () => (footerProps: any) => <ResultsFooter {...footerProps} onClose={onClose} />,
      [onClose],
    );

  useDocSearchKeyboardEvents({
    isOpen,
    onOpen,
    onClose,
    onInput,
    searchButtonRef,
  });

  return (
    <>
      <DocSearchButton
        onTouchStart={importDocSearchModalIfNeeded}
        onFocus={importDocSearchModalIfNeeded}
        onMouseOver={importDocSearchModalIfNeeded}
        onClick={onOpen}
        ref={searchButtonRef}
        translations={translations.button}
      />

      {isOpen &&
        DocSearchModal &&
        searchContainer.current &&
        createPortal(
          <>
            <DocSearchModal
              onClose={onClose}
              initialScrollY={window.scrollY}
              initialQuery={initialQuery}
              navigator={navigator}
              transformItems={transformItems}
              hitComponent={Hit}
              {...(props.searchPagePath && { resultsFooterComponent })}
              {...props}
              typesenseSearchParameters={typesenseSearchParameters}
              typesenseServerConfig={typesenseServerConfig}
              typesenseCollectionName={typesenseCollectionName}
              placeholder={translations.placeholder}
              // @ts-ignore
              translations={translations.modal}
            />
            {modalNode && createPortal(
              <FilterBar selected={selectedProjects} onChange={setSelectedProjects} />,
              modalNode
            )}
          </>,
          searchContainer.current,
        )}
    </>
  );
}

export default function SearchBar(): React.ReactElement {
  const {siteConfig} = useDocusaurusContext();
  return (
    <DocSearch {...(siteConfig.themeConfig.typesense as DocSearchProps)} />
  );
}

--------------------------------------------------------------------------------

FILE: website/src/theme/SearchBar/styles.css
--------------------------------------------------------------------------------
:root {
  --docsearch-primary-color: var(--ifm-color-primary);
  --docsearch-text-color: var(--ifm-font-color-base);
  --docsearch-modal-background: var(--ifm-background-color);
  --docsearch-footer-background: var(--ifm-background-color);
  --docsearch-searchbox-background: var(--ifm-color-emphasis-200);
  --docsearch-searchbox-focus-background: var(--ifm-background-color);
  --docsearch-hit-color: var(--ifm-font-color-base);
  --docsearch-hit-shadow: none;
  --docsearch-hit-background: var(--ifm-background-color);
  --docsearch-key-gradient: none;
  --docsearch-key-shadow: none;
}

.DocSearch-Button {
  margin: 0;
  transition: all var(--ifm-transition-fast)
    var(--ifm-transition-timing-default);
}

.DocSearch-Container {
  z-index: calc(var(--ifm-z-index-fixed) + 1);
}

/* --- Filter Bar Integration --- */

.DocSearch-Dropdown {
  margin-top: 50px !important; 
}

/* Container for the filter bar */
.ProjectFilter-Bar {
  position: absolute;
  top: 74px; 
  left: 0;
  right: 0;
  height: 50px;
  display: flex;
  align-items: center;
  padding: 0 var(--docsearch-spacing);
  gap: 8px;
  background: var(--docsearch-modal-background);
  border-bottom: 1px solid var(--docsearch-border-color, #ccc);
  z-index: 500;
  overflow: visible; /* Allow dropdown to overflow */
}

/* The "Add Filter +" Button */
.ProjectFilter-AddButton {
  background: transparent;
  color: var(--docsearch-text-color);
  border: 1px dashed var(--ifm-color-emphasis-400);
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 0.85rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  flex-shrink: 0;
}
.ProjectFilter-AddButton:hover {
  border-color: var(--docsearch-primary-color);
  color: var(--docsearch-primary-color);
  background: var(--ifm-color-emphasis-100);
}

/* Selected Project Chips */
.ProjectFilter-Chip {
  background: var(--docsearch-primary-color);
  color: white;
  border: 1px solid var(--docsearch-primary-color);
  border-radius: 20px;
  padding: 4px 10px;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
  animation: fadein 0.2s;
}
.ProjectFilter-Chip:hover {
  opacity: 0.9;
}
.ProjectFilter-Chip-Remove {
  font-size: 1rem;
  line-height: 1;
  opacity: 0.7;
}
.ProjectFilter-Chip-Remove:hover {
  opacity: 1;
}

/* Dropdown Menu */
.ProjectFilter-Dropdown {
  position: absolute;
  top: 45px; /* Below the bar */
  left: 10px;
  width: 280px;
  max-height: 300px;
  background: var(--docsearch-modal-background);
  border: 1px solid var(--ifm-color-emphasis-300);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 1000;
}

/* Search Input inside Dropdown */
.ProjectFilter-SearchInput {
  width: 100%;
  padding: 10px;
  border: none;
  border-bottom: 1px solid var(--ifm-color-emphasis-200);
  background: var(--ifm-background-color);
  color: var(--docsearch-text-color);
  outline: none;
  font-size: 0.9rem;
}

/* Scrollable List */
.ProjectFilter-List {
  overflow-y: auto;
  flex: 1;
}

/* List Items */
.ProjectFilter-Item {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9rem;
  color: var(--docsearch-text-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ProjectFilter-Item:hover, .ProjectFilter-Item.focused {
  background: var(--ifm-color-emphasis-100);
  color: var(--docsearch-primary-color);
}
.ProjectFilter-Item.selected {
  background: var(--ifm-color-emphasis-200);
  font-weight: bold;
}

@keyframes fadein {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

--------------------------------------------------------------------------------

FILE: docker-compose.yml
--------------------------------------------------------------------------------
services:
  docusaurus-site:
    build:
      context: ./website
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    volumes:
      - ./website:/app
      - /app/node_modules
    restart: always

  typesense:
    image: typesense/typesense:26.0
    restart: on-failure
    ports:
      - "8108:8108"
    volumes:
      - ./typesense-data:/data
    command: '--data-dir /data --api-key=xyz --enable-cors'

  typesense-scraper:
    image: typesense/docsearch-scraper:0.11.0
    network_mode: host 
    environment:
      - CONFIG_FILE_PATH=/config/scraper-config.json
    volumes:
      - ./scraper-config.json:/config/scraper-config.json

--------------------------------------------------------------------------------

FILE: scraper-config.json
--------------------------------------------------------------------------------
{
  "index_name": "docusaurus-2",
  "start_urls": [
    "http://docusaurus:80/"
  ],
  "sitemap_urls": [
    "http://docusaurus:80/sitemap.xml"
  ],
  "selectors": {
    "lvl0": {
      "selector": ".menu__link--active",
      "global": true,
      "default_value": "Documentation"
    },
    "lvl1": "header h1",
    "lvl2": "article h2",
    "lvl3": "article h3",
    "lvl4": "article h4",
    "lvl5": "article h5, article h6",
    "text": "article p, article li, article td"
  },
  "strip_chars": " .,;:#",
  "custom_settings": {
    "attributesForFaceting": [
      "type",
      "lang",
      "language",
      "version",
      "docusaurus_tag"
    ]
  }
}